version: 2

sources:
  - name: raw
    description: Raw rental property data loaded from source systems
    database: RENTAL_PROPERTY
    schema: raw
    
    # ==========================================================================
    # Source Freshness Configuration
    # ==========================================================================
    # Used by: dbt source freshness
    # Checked by: Airflow DAG before pipeline execution
    #
    # Thresholds:
    #   - warn_after: Log warning but continue pipeline
    #   - error_after: Block pipeline and send alert
    #
    # The loaded_at_field should be a timestamp column that indicates when
    # the data was last loaded/updated in the source table.
    # ==========================================================================
    
    freshness:
      warn_after: {count: 24, period: hour}
      error_after: {count: 48, period: hour}
    
    # Default loaded_at field for freshness (explicit per table below)
    loaded_at_field: _loaded_at
    
    tables:
      # ========================================================================
      # Listings Table
      # ========================================================================
      - name: listings
        description: Property listings with host and amenity information
        freshness:
          warn_after: {count: 7, period: day}
          error_after: {count: 14, period: day}
        loaded_at_field: _loaded_at
        columns:
          - name: id
            description: Unique listing identifier
            tests:
              - unique
              - not_null
          - name: neighborhood
            description: Neighborhood where the property is located
          - name: amenities
            description: JSON array of amenities as text
          - name: price
            description: Base nightly price
          - name: host_id
            description: Foreign key to host
            tests:
              - not_null
          - name: property_type
            description: Type of property
          - name: room_type
            description: Type of room offered
      
      # ========================================================================
      # Calendar Table
      # ========================================================================
      - name: calendar
        description: Daily availability and pricing per listing
        freshness:
          warn_after: {count: 24, period: hour}
          error_after: {count: 48, period: hour}
        loaded_at_field: _loaded_at
        columns:
          - name: listing_id
            description: Foreign key to listings
            tests:
              - not_null
          - name: date
            description: Calendar date
            tests:
              - not_null
          - name: available
            description: Availability flag (t/f)
            tests:
              - not_null
          - name: price
            description: Price for this specific date
      
      # ========================================================================
      # Reviews Table
      # ========================================================================
      - name: generated_reviews
        description: Synthetic review data with scores
        freshness:
          warn_after: {count: 7, period: day}
          error_after: {count: 14, period: day}
        loaded_at_field: _loaded_at
        columns:
          - name: id
            description: Unique review identifier
            tests:
              - unique
              - not_null:
                  config:
                    severity: warn
                    # Note: 2 null IDs exist in source data
          - name: listing_id
            description: Foreign key to listings
          - name: review_score
            description: Numeric review score
          - name: review_date
            description: Date of the review
      
      # ========================================================================
      # Amenities Changelog Table
      # ========================================================================
      - name: amenities_changelog
        description: Historical record of amenity changes per listing
        freshness:
          warn_after: {count: 7, period: day}
          error_after: {count: 14, period: day}
        loaded_at_field: _loaded_at
        columns:
          - name: listing_id
            description: Foreign key to listings
            tests:
              - not_null
          - name: change_at
            description: Timestamp when amenities were updated
            tests:
              - not_null
          - name: amenities
            description: JSON array of amenities at this point in time
            tests:
              - not_null
