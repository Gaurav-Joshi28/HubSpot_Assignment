# ğŸ  Rental Property Analytics

> **A production-ready dbt data pipeline for rental property performance analysis**

Built with **dbt + Snowflake + Airflow** | Dynamic Amenity Parsing | SCD Type 2 | Incremental Loading

---

## ğŸ“‹ Table of Contents

1. [Pipeline Architecture](#-pipeline-architecture)
2. [Project Structure](#-project-structure)
3. [Data Flow](#-data-flow)
4. [Data Model](#-data-model)
5. [Schema Change Handling](#-schema-change-handling-new-amenities)
6. [Business Questions](#-business-questions-answered)
7. [Snowflake Setup](#-snowflake-setup)
8. [Running the Project](#-running-the-project)
9. [Monitoring & Alerts](#-monitoring--alerts)
10. [Audit Timestamps & Data Lineage](#-audit-timestamps--data-lineage)
11. [Join Strategy & Performance Optimizations](#-join-strategy--performance-optimizations)
12. [Tests & Data Quality](#-tests--data-quality)
12. [Edge Cases & Future Enhancements](#-edge-cases--future-enhancements)
    - [Future Enhancement Opportunities](#future-enhancement-opportunities)
    - [Production Readiness Checklist](#production-readiness-checklist)

---

## ğŸš€ Pipeline Architecture

**Architecture style:** Medallion-inspired layering  
- Raw â†” Stagging â†” Development â†” Mart â†” Analytics mirrors Bronze/Silver/Gold+ semantics for controlled refinement.  
- Mart layer uses a star schema (facts with conformed dimensions) to keep BI-friendly joins and predictable grain.

### Airflow DAG Overview

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        AIRFLOW DAG: dbt_rental_property_pipeline                   â•‘
â•‘                              Schedule: Daily @ 6:00 AM UTC                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 0: SOURCE FRESHNESS CHECK                      â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â•‘
â•‘  â”‚    â”‚  START  â”‚â”€â”€â”€â”€â”€â–¶â”‚ check_source_       â”‚â”€â”€â”€â”€â”€â–¶â”‚  Branch Decision   â”‚     â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ freshness           â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â•‘
â•‘  â”‚                     â”‚                     â”‚                â”‚                â”‚ â•‘
â•‘  â”‚                     â”‚ â€¢ raw.listings      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â•‘
â•‘  â”‚                     â”‚ â€¢ raw.calendar      â”‚      â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚                     â”‚ â€¢ raw.reviews       â”‚      â–¼         â–¼         â–¼      â”‚ â•‘
â•‘  â”‚                     â”‚ â€¢ raw.amenities     â”‚   â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚ â•‘
â•‘  â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ âœ…  â”‚  â”‚  âš ï¸   â”‚  â”‚  ğŸš¨  â”‚  â”‚ â•‘
â•‘  â”‚                                               â”‚PASS â”‚  â”‚ WARN  â”‚  â”‚FAIL  â”‚  â”‚ â•‘
â•‘  â”‚                                               â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â”‚ â•‘
â•‘  â”‚                                                  â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚                                                  â”‚    Continue       â”‚      â”‚ â•‘
â•‘  â”‚                                                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚      â”‚ â•‘
â•‘  â”‚                                                       â”‚              â–¼      â”‚ â•‘
â•‘  â”‚                                                       â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â•‘
â•‘  â”‚                                                       â”‚      â”‚  BLOCKED   â”‚ â”‚ â•‘
â•‘  â”‚                                                       â”‚      â”‚ Email Sent â”‚ â”‚ â•‘
â•‘  â”‚                                                       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                                          â–¼                        â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 1: DBT SETUP                                   â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚ â•‘
â•‘  â”‚    â”‚   dbt deps      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   dbt debug     â”‚                          â”‚ â•‘
â•‘  â”‚    â”‚ Install packagesâ”‚         â”‚ Test connection â”‚                          â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                            â–¼                                      â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 2: STAGING LAYER                               â”‚ â•‘
â•‘  â”‚                         Schema: RENTAL_PROPERTY.STAGGING                     â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â•‘
â•‘  â”‚    â”‚stg_listings â”‚  â”‚stg_calendar â”‚  â”‚ stg_reviews â”‚  â”‚stg_amenities_     â”‚ â”‚ â•‘
â•‘  â”‚    â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚changelog          â”‚ â”‚ â•‘
â•‘  â”‚    â”‚ â€¢ Parse $   â”‚  â”‚ â€¢ Cast datesâ”‚  â”‚ â€¢ Clean IDs â”‚  â”‚ â€¢ Dynamic PIVOT   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚ â€¢ Parse JSONâ”‚  â”‚ â€¢ Calc flagsâ”‚  â”‚ â€¢ Validate  â”‚  â”‚ â€¢ JSON flatten    â”‚ â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â•‘
â•‘  â”‚           â”‚                â”‚                â”‚                  â”‚            â”‚ â•‘
â•‘  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â•‘
â•‘  â”‚                                     â”‚  PARALLEL                             â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                        â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 3: INTERMEDIATE LAYER                          â”‚ â•‘
â•‘  â”‚                         Schema: RENTAL_PROPERTY.DEVELOPMENT                  â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â•‘
â•‘  â”‚    â”‚                    int_listing_amenities_scd                        â”‚  â”‚ â•‘
â•‘  â”‚    â”‚                    (SCD Type 2 for amenities)                       â”‚  â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â•‘
â•‘  â”‚                                     â”‚                                       â”‚ â•‘
â•‘  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â•‘
â•‘  â”‚         â”‚                           â”‚                           â”‚          â”‚ â•‘
â•‘  â”‚         â–¼                           â–¼                           â–¼          â”‚ â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â•‘
â•‘  â”‚  â”‚int_hosts_    â”‚          â”‚int_listings_   â”‚          â”‚int_availabilityâ”‚  â”‚ â•‘
â•‘  â”‚  â”‚history       â”‚          â”‚history         â”‚          â”‚_spans          â”‚  â”‚ â•‘
â•‘  â”‚  â”‚              â”‚          â”‚                â”‚          â”‚                â”‚  â”‚ â•‘
â•‘  â”‚  â”‚ SCD Type 2   â”‚          â”‚ SCD Type 2     â”‚          â”‚ Consecutive    â”‚  â”‚ â•‘
â•‘  â”‚  â”‚ valid_from/toâ”‚          â”‚ valid_from/to  â”‚          â”‚ day grouping   â”‚  â”‚ â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â•‘
â•‘  â”‚                                     â”‚                                       â”‚ â•‘
â•‘  â”‚                                     â–¼                                       â”‚ â•‘
â•‘  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚ â•‘
â•‘  â”‚                        â”‚  int_calendar_enriched â”‚                          â”‚ â•‘
â•‘  â”‚                        â”‚                        â”‚                          â”‚ â•‘
â•‘  â”‚                        â”‚ â€¢ Join listings        â”‚                          â”‚ â•‘
â•‘  â”‚                        â”‚ â€¢ Join hosts           â”‚                          â”‚ â•‘
â•‘  â”‚                        â”‚ â€¢ Join amenities (SCD) â”‚                          â”‚ â•‘
â•‘  â”‚                        â”‚ â€¢ Calculate revenue    â”‚                          â”‚ â•‘
â•‘  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                        â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                    PHASE 3.5: SCHEMA CHANGE DETECTION                        â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â•‘
â•‘  â”‚    â”‚ check_schema_       â”‚â”€â”€â”€â”€â”€â–¶â”‚  Compare source vs target columns       â”‚ â”‚ â•‘
â•‘  â”‚    â”‚ changes             â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚                         â”‚ â•‘
â•‘  â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â•‘
â•‘  â”‚                                    â–¼                             â–¼          â”‚ â•‘
â•‘  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â•‘
â•‘  â”‚                            â”‚ NEW AMENITY  â”‚              â”‚ NO CHANGE    â”‚   â”‚ â•‘
â•‘  â”‚                            â”‚ DETECTED     â”‚              â”‚              â”‚   â”‚ â•‘
â•‘  â”‚                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â•‘
â•‘  â”‚                                   â–¼                             â–¼           â”‚ â•‘
â•‘  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â•‘
â•‘  â”‚                            â”‚ FULL REFRESH â”‚              â”‚ INCREMENTAL  â”‚   â”‚ â•‘
â•‘  â”‚                            â”‚ triggered    â”‚              â”‚ (last 7 days)â”‚   â”‚ â•‘
â•‘  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                        â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 4: MART LAYER                                  â”‚ â•‘
â•‘  â”‚                         Schema: RENTAL_PROPERTY.MART                         â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â•‘
â•‘  â”‚    â”‚                         DIMENSIONS                                  â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â”‚ dim_date  â”‚       â”‚dim_hosts  â”‚       â”‚    dim_listings       â”‚ â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â”‚           â”‚       â”‚           â”‚       â”‚                       â”‚ â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â”‚ â€¢ Fiscal  â”‚       â”‚ â€¢ SCD 2   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ SCD Type 2          â”‚ â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â”‚ â€¢ Seasons â”‚       â”‚ â€¢ History â”‚       â”‚ â€¢ All amenity flags   â”‚ â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â”‚ â€¢ Holidaysâ”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â•‘
â•‘  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                       â”‚             â”‚  â”‚ â•‘
â•‘  â”‚    â”‚        â”‚                                             â”‚             â”‚  â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â•‘
â•‘  â”‚             â”‚                                             â”‚                â”‚ â•‘
â•‘  â”‚             â–¼                                             â–¼                â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â•‘
â•‘  â”‚    â”‚                           FACTS                                     â”‚ â”‚ â•‘
â•‘  â”‚    â”‚                                                                     â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚            fct_daily_listing_performance                    â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚                                                             â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚  Grain: listing_id Ã— calendar_date                          â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚  Strategy: INCREMENTAL (merge on unique_key)                â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚  on_schema_change: sync_all_columns                         â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚                                                             â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚  Metrics: daily_revenue, is_occupied, adjusted_price        â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚  Dimensions: All from dim_date, dim_listings, dim_hosts     â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚  Amenities: 50+ dynamic boolean columns                     â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚                             â”‚                                      â”‚ â”‚ â•‘
â•‘  â”‚    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚ â”‚ â•‘
â•‘  â”‚    â”‚              â–¼                             â–¼                      â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚fct_monthly_listing_     â”‚   â”‚fct_monthly_neighborhood_    â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚performance              â”‚   â”‚summary                      â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚                         â”‚   â”‚                             â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚ Grain: listing Ã— month  â”‚   â”‚ Grain: neighborhood Ã— month â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â”‚ Pre-aggregated rollup   â”‚   â”‚ Pre-aggregated rollup       â”‚   â”‚ â”‚ â•‘
â•‘  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                        â”‚                                          â•‘
â•‘                                        â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 5: ANALYTICS LAYER                             â”‚ â•‘
â•‘  â”‚                         Schema: RENTAL_PROPERTY.ANALYTICS                    â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â•‘
â•‘  â”‚   â”‚problem_1_amenity_ â”‚  â”‚problem_2_         â”‚  â”‚problem_3a_max_stay_    â”‚  â”‚ â•‘
â•‘  â”‚   â”‚revenue            â”‚  â”‚neighborhood_      â”‚  â”‚duration                â”‚  â”‚ â•‘
â•‘  â”‚   â”‚                   â”‚  â”‚pricing            â”‚  â”‚                        â”‚  â”‚ â•‘
â•‘  â”‚   â”‚ AC vs Non-AC      â”‚  â”‚ YoY price change  â”‚  â”‚ Longest consecutive    â”‚  â”‚ â•‘
â•‘  â”‚   â”‚ monthly revenue % â”‚  â”‚ by neighborhood   â”‚  â”‚ availability           â”‚  â”‚ â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â•‘
â•‘  â”‚                          â”‚problem_3b_max_stay_    â”‚                         â”‚ â•‘
â•‘  â”‚                          â”‚lockbox_firstaid        â”‚                         â”‚ â•‘
â•‘  â”‚                          â”‚                        â”‚                         â”‚ â•‘
â•‘  â”‚                          â”‚ Max stay with specific â”‚                         â”‚ â•‘
â•‘  â”‚                          â”‚ amenity combination    â”‚                         â”‚ â•‘
â•‘  â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â•‘
â•‘  â”‚                                     â”‚  PARALLEL                             â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                        â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                         PHASE 6: VALIDATION                                  â”‚ â•‘
â•‘  â”‚                                                                              â”‚ â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â•‘
â•‘  â”‚    â”‚   dbt test      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   dbt docs      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   END   â”‚      â”‚ â•‘
â•‘  â”‚    â”‚                 â”‚         â”‚   generate      â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚    â”‚ â€¢ unique        â”‚         â”‚                 â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚    â”‚ â€¢ not_null      â”‚         â”‚ Documentation   â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚    â”‚ â€¢ relationships â”‚         â”‚ for all models  â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚    â”‚ â€¢ custom rules  â”‚         â”‚                 â”‚         â”‚         â”‚      â”‚ â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Late Arrival Detection (automatic backfill trigger)**  
- Runs after freshness and before schema change detection.  
- Uses `dbt run-operation check_late_arrivals --args '{"window_days":7,"lookback_loaded_hours":48}'` to find rows whose business date is older than the incremental window but were ingested recently via `_loaded_at`.  
- If late arrivals exist, Airflow branches to a full refresh of `fct_daily_listing_performance`; otherwise it proceeds with the normal incremental path.  
- For large late loads, you can still run off-hours or chunk backfills; the branch is a hook to choose the safer/full-refresh path automatically.

### Pipeline Execution Summary

| Phase | Tasks | Execution | Duration |
|-------|-------|-----------|----------|
| **0. Freshness** | Source validation (_loaded_at) | Sequential | ~30s |
| **0.5 Late Arrivals** | Check old business dates | Sequential | ~10s |
| **1. Setup** | deps â†’ debug | Sequential | ~1min |
| **2. Staging** | 4 models (views) | Parallel | ~2min |
| **3. Intermediate** | 5 models (views) | Mixed | ~3min |
| **3.5 Schema Check** | New amenity columns | Sequential | ~10s |
| **4. Marts** | 6 models (tables w/ dbt_updated_at) | Sequential | ~5min |
| **5. Analytics** | 4 models (views) | Parallel | ~1min |
| **6. Validation** | test â†’ docs | Sequential | ~2min |

#### Late Arrival Detection (automatic backfill trigger)
- Runs before schema-change detection.
- Uses `dbt run-operation check_late_arrivals --args '{"window_days":7,"lookback_loaded_hours":48}'` to find rows whose business date is older than the incremental window but were ingested recently (requires `_loaded_at` in raw).
- If late arrivals are found, Airflow branches to a full refresh for `fct_daily_listing_performance`; otherwise it proceeds with the normal incremental path.
- For very large backfills, run off-hours with a larger warehouse or chunk by date ranges; the same branch can be extended to choose a chunked strategy based on late row counts.

---

## ğŸ“ Project Structure

```
rental_property/
â”‚
â”œâ”€â”€ ğŸ“„ dbt_project.yml                    # Project configuration
â”œâ”€â”€ ğŸ“„ profiles.yml                       # Snowflake connection (local)
â”œâ”€â”€ ğŸ“„ profiles.yml.docker                # Snowflake connection (Docker)
â”œâ”€â”€ ğŸ“„ README.md                          # This documentation
â”‚
â”œâ”€â”€ ğŸ³ DOCKER & AIRFLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”œâ”€â”€ ğŸ“„ Dockerfile                     # dbt standalone image
â”‚   â”œâ”€â”€ ğŸ“„ Dockerfile.airflow             # Airflow + dbt image
â”‚   â”œâ”€â”€ ğŸ“„ docker-compose.yml             # Full stack orchestration
â”‚   â”œâ”€â”€ ğŸ“„ env.example                    # Environment template
â”‚   â””â”€â”€ ğŸ“„ .gitignore                     # Ignore sensitive files
â”‚
â”œâ”€â”€ ğŸ“‚ dags/
â”‚   â””â”€â”€ ğŸ“„ dbt_rental_property_dag.py     # Airflow DAG definition
â”‚
â”œâ”€â”€ ğŸ“‚ macros/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ get_amenity_columns.sql        # Dynamic amenity column generator
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ get_amenity_columns()         â†’ For amenities_changelog
â”‚   â”‚   â””â”€â”€ get_listing_amenity_columns() â†’ For listings table
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ detect_schema_changes.sql      # Schema change detection
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ check_amenity_schema_change() â†’ Detect new amenity columns
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ check_late_arrivals.sql       # Late arrival detection
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ check_late_arrivals()        â†’ Find old business dates recently loaded
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ generate_schema_name.sql       # Custom schema routing
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Routes models to correct schemas:
â”‚   â”‚       staging      â†’ STAGGING
â”‚   â”‚       intermediate â†’ DEVELOPMENT
â”‚   â”‚       marts        â†’ MART
â”‚   â”‚       analyses     â†’ ANALYTICS
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“„ generate_surrogate_key.sql     # SK generation helper
â”‚
â”œâ”€â”€ ğŸ“‚ models/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ staging/                       # LAYER 1: Clean & Standardize
â”‚   â”‚   â”‚   Schema: RENTAL_PROPERTY.STAGGING
â”‚   â”‚   â”‚   Materialization: VIEW
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _sources.yml               # Source definitions + freshness
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _staging.yml               # Model tests & docs
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ stg_listings.sql           # Parse prices, JSON amenities
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ stg_calendar.sql           # Date casting, availability flags
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ stg_reviews.sql            # ID cleaning, score validation
â”‚   â”‚   â””â”€â”€ ğŸ“„ stg_amenities_changelog.sql # Dynamic PIVOT of amenities
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ intermediate/                  # LAYER 2: Transform & Enrich
â”‚   â”‚   â”‚   Schema: RENTAL_PROPERTY.DEVELOPMENT
â”‚   â”‚   â”‚   Materialization: VIEW
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _intermediate.yml          # Model tests & docs
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ int_listing_amenities_scd.sql  # SCD Type 2 for amenities
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ int_hosts_history.sql      # SCD Type 2 for hosts
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ int_listings_history.sql   # SCD Type 2 for listings
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ int_availability_spans.sql # Consecutive day grouping
â”‚   â”‚   â””â”€â”€ ğŸ“„ int_calendar_enriched.sql  # Master enrichment join
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ marts/                         # LAYER 3: Business-Ready
â”‚   â”‚   â”‚   Schema: RENTAL_PROPERTY.MART
â”‚   â”‚   â”‚   Materialization: TABLE
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ _marts.yml                 # Model tests & docs
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ dim_date.sql               # Date dimension (fiscal, holidays)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ dim_hosts.sql              # Host dimension (SCD Type 2)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ dim_listings.sql           # Listing dimension (SCD Type 2)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ fct_daily_listing_performance.sql    # INCREMENTAL fact
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ fct_monthly_listing_performance.sql  # Monthly rollup
â”‚   â”‚   â””â”€â”€ ğŸ“„ fct_monthly_neighborhood_summary.sql # Neighborhood rollup
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“‚ analyses/                      # LAYER 4: Business Answers
â”‚       â”‚   Schema: RENTAL_PROPERTY.ANALYTICS
â”‚       â”‚   Materialization: VIEW
â”‚       â”‚
â”‚       â”œâ”€â”€ ğŸ“„ problem_1_amenity_revenue.sql        # AC revenue analysis
â”‚       â”œâ”€â”€ ğŸ“„ problem_2_neighborhood_pricing.sql   # YoY price change
â”‚       â”œâ”€â”€ ğŸ“„ problem_3a_max_stay_duration.sql     # Max consecutive stay
â”‚       â””â”€â”€ ğŸ“„ problem_3b_max_stay_lockbox_firstaid.sql # Amenity-filtered stay
â”‚
â”œâ”€â”€ ğŸ“‚ seeds/                             # Static reference data
â”‚   â””â”€â”€ (CSV files if any)
â”‚
â”œâ”€â”€ ğŸ“‚ tests/                             # Custom singular tests
â”‚   â””â”€â”€ (Custom test SQL files)
â”‚
â”œâ”€â”€ ğŸ“‚ target/                            # Compiled SQL (generated)
â”‚   â””â”€â”€ (Auto-generated, gitignored)
â”‚
â””â”€â”€ ğŸ“‚ logs/                              # dbt run logs (generated)
    â””â”€â”€ (Auto-generated, gitignored)
```

### File Count by Layer

| Layer | SQL Models | YAML Configs | Total |
|-------|------------|--------------|-------|
| Staging | 4 | 2 | 6 |
| Intermediate | 5 | 1 | 6 |
| Marts | 6 | 1 | 7 |
| Analytics | 4 | 0 | 4 |
| Macros | 4 | 0 | 4 |
| **Total** | **23** | **4** | **27** |

---

## ğŸ”„ Data Flow

### Source to Analytics Journey

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                   DATA FLOW                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                      â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘  â”‚                              SOURCE SYSTEMS                                      â”‚â•‘
â•‘  â”‚                                                                                  â”‚â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â•‘
â•‘  â”‚   â”‚   Listings   â”‚   â”‚   Calendar   â”‚   â”‚   Reviews    â”‚   â”‚  Amenities   â”‚    â”‚â•‘
â•‘  â”‚   â”‚    CSV/API   â”‚   â”‚    CSV/API   â”‚   â”‚   CSV/API    â”‚   â”‚  Changelog   â”‚    â”‚â•‘
â•‘  â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚   â”‚   CSV/API    â”‚    â”‚â•‘
â•‘  â”‚   â”‚ â€¢ 3,500 rows â”‚   â”‚ â€¢ 1.2M rows  â”‚   â”‚ â€¢ 50K rows   â”‚   â”‚ â€¢ 15K rows   â”‚    â”‚â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•‘             â”‚                  â”‚                  â”‚                  â”‚              â•‘
â•‘             â–¼                  â–¼                  â–¼                  â–¼              â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘  â”‚                           RAW SCHEMA (raw.*)                                    â”‚â•‘
â•‘  â”‚                           Snowflake External Tables / Seeds                     â”‚â•‘
â•‘  â”‚                                                                                 â”‚â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â•‘
â•‘  â”‚   â”‚raw.listings  â”‚   â”‚raw.calendar  â”‚   â”‚raw.generated â”‚   â”‚raw.amenities_â”‚   â”‚â•‘
â•‘  â”‚   â”‚              â”‚   â”‚              â”‚   â”‚_reviews      â”‚   â”‚changelog     â”‚   â”‚â•‘
â•‘  â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚   â”‚â•‘
â•‘  â”‚   â”‚ id           â”‚   â”‚ listing_id   â”‚   â”‚ id           â”‚   â”‚ listing_id   â”‚   â”‚â•‘
â•‘  â”‚   â”‚ name         â”‚   â”‚ date         â”‚   â”‚ listing_id   â”‚   â”‚ change_at    â”‚   â”‚â•‘
â•‘  â”‚   â”‚ price ($125) â”‚   â”‚ available    â”‚   â”‚ review_score â”‚   â”‚ amenities    â”‚   â”‚â•‘
â•‘  â”‚   â”‚ amenities [] â”‚   â”‚ price        â”‚   â”‚ review_date  â”‚   â”‚ (JSON array) â”‚   â”‚â•‘
â•‘  â”‚   â”‚ host_id      â”‚   â”‚ min_nights   â”‚   â”‚              â”‚   â”‚              â”‚   â”‚â•‘
â•‘  â”‚   â”‚ neighborhood â”‚   â”‚ max_nights   â”‚   â”‚              â”‚   â”‚              â”‚   â”‚â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•‘             â”‚                  â”‚                  â”‚                  â”‚              â•‘
â•‘             â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚              â•‘
â•‘             â”‚   â•‘           TRANSFORMATIONS APPLIED                â•‘ â”‚              â•‘
â•‘             â”‚   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚              â•‘
â•‘             â”‚   â•‘ â€¢ Remove $ from prices                           â•‘ â”‚              â•‘
â•‘             â”‚   â•‘ â€¢ Cast strings to dates                          â•‘ â”‚              â•‘
â•‘             â”‚   â•‘ â€¢ Parse JSON amenities to columns                â•‘ â”‚              â•‘
â•‘             â”‚   â•‘ â€¢ Calculate derived fields                       â•‘ â”‚              â•‘
â•‘             â”‚   â•‘ â€¢ Standardize naming conventions                 â•‘ â”‚              â•‘
â•‘             â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚              â•‘
â•‘             â”‚                  â”‚                  â”‚                  â”‚              â•‘
â•‘             â–¼                  â–¼                  â–¼                  â–¼              â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘  â”‚                        STAGING SCHEMA (stagging.*)                              â”‚â•‘
â•‘  â”‚                        Materialization: VIEW                                    â”‚â•‘
â•‘  â”‚                                                                                 â”‚â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â•‘
â•‘  â”‚   â”‚stg_listings  â”‚   â”‚stg_calendar  â”‚   â”‚stg_reviews   â”‚   â”‚stg_amenities_â”‚   â”‚â•‘
â•‘  â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚   â”‚changelog     â”‚   â”‚â•‘
â•‘  â”‚   â”‚ listing_id   â”‚   â”‚ listing_id   â”‚   â”‚ review_id    â”‚   â”‚              â”‚   â”‚â•‘
â•‘  â”‚   â”‚ listing_name â”‚   â”‚ calendar_dateâ”‚   â”‚ listing_id   â”‚   â”‚ listing_id   â”‚   â”‚â•‘
â•‘  â”‚   â”‚ base_price   â”‚   â”‚ is_available â”‚   â”‚ review_score â”‚   â”‚ change_at    â”‚   â”‚â•‘
â•‘  â”‚   â”‚ (NUMERIC)    â”‚   â”‚ is_reserved  â”‚   â”‚ review_date  â”‚   â”‚ "WiFi" âœ“     â”‚   â”‚â•‘
â•‘  â”‚   â”‚ neighborhood â”‚   â”‚ daily_price  â”‚   â”‚              â”‚   â”‚ "Pool" âœ“     â”‚   â”‚â•‘
â•‘  â”‚   â”‚ "WiFi" âœ“     â”‚   â”‚ is_weekend   â”‚   â”‚              â”‚   â”‚ "AC" âœ“       â”‚   â”‚â•‘
â•‘  â”‚   â”‚ "Pool" âœ“     â”‚   â”‚              â”‚   â”‚              â”‚   â”‚ ... (50+)    â”‚   â”‚â•‘
â•‘  â”‚   â”‚ "AC" âœ“       â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚   â”‚â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•‘             â”‚                  â”‚                  â”‚                  â”‚              â•‘
â•‘             â”‚                  â”‚                  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
â•‘             â”‚                  â”‚                  â”‚         â”‚                       â•‘
â•‘             â”‚                  â”‚                  â”‚         â–¼                       â•‘
â•‘             â”‚                  â”‚                  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚ int_listing_amenities_  â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚ scd                     â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚                         â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚ â€¢ SCD Type 2            â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚ â€¢ valid_from / valid_to â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚ â€¢ Point-in-time amenity â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â”‚   state                 â”‚  â•‘
â•‘             â”‚                  â”‚                  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘             â”‚                  â”‚                  â”‚               â”‚                â•‘
â•‘             â–¼                  â”‚                  â”‚               â”‚                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                  â”‚               â”‚                â•‘
â•‘  â”‚ int_hosts_history       â”‚   â”‚                  â”‚               â”‚                â•‘
â•‘  â”‚ int_listings_history    â”‚   â”‚                  â”‚               â”‚                â•‘
â•‘  â”‚                         â”‚   â”‚                  â”‚               â”‚                â•‘
â•‘  â”‚ â€¢ SCD Type 2            â”‚   â”‚                  â”‚               â”‚                â•‘
â•‘  â”‚ â€¢ Track attribute       â”‚   â”‚                  â”‚               â”‚                â•‘
â•‘  â”‚   changes over time     â”‚   â”‚                  â”‚               â”‚                â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                  â”‚               â”‚                â•‘
â•‘              â”‚                 â”‚                  â”‚               â”‚                â•‘
â•‘              â”‚                 â–¼                  â”‚               â”‚                â•‘
â•‘              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘              â”‚    â”‚                    int_calendar_enriched                   â”‚  â•‘
â•‘              â”‚    â”‚                                                            â”‚  â•‘
â•‘              â””â”€â”€â”€â–¶â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â•‘
â•‘                   â”‚  â”‚              MASTER ENRICHMENT JOIN                  â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚                                                      â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚  Calendar â—€â”€â”€â”¬â”€â”€â–¶ Listings (point-in-time)          â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚              â”œâ”€â”€â–¶ Hosts (point-in-time)             â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚              â””â”€â”€â–¶ Amenities (SCD valid range)       â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚                                                      â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚  Grain: listing_id Ã— calendar_date                   â”‚ â”‚  â•‘
â•‘                   â”‚  â”‚  Rows: ~1.2 million                                  â”‚ â”‚  â•‘
â•‘                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â•‘
â•‘                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                                 â”‚                                  â•‘
â•‘                                                 â”‚                                  â•‘
â•‘             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘             â”‚                        DEVELOPMENT SCHEMA                          â”‚â•‘
â•‘             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•‘                                                 â”‚                                  â•‘
â•‘                                                 â–¼                                  â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘  â”‚                          MART SCHEMA (mart.*)                                   â”‚â•‘
â•‘  â”‚                          Materialization: TABLE                                 â”‚â•‘
â•‘  â”‚                                                                                 â”‚â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â•‘
â•‘  â”‚   â”‚                           DIMENSIONS                                      â”‚â”‚â•‘
â•‘  â”‚   â”‚                                                                           â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚   dim_date     â”‚  â”‚   dim_hosts    â”‚  â”‚       dim_listings         â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                            â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ date_key (PK)  â”‚  â”‚ host_pk (PK)   â”‚  â”‚ listing_pk (PK)            â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ date_day       â”‚  â”‚ host_id (NK)   â”‚  â”‚ listing_id (NK)            â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ day_of_week    â”‚  â”‚ host_name      â”‚  â”‚ listing_name               â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ month_name     â”‚  â”‚ host_location  â”‚  â”‚ neighborhood               â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ quarter        â”‚  â”‚ host_since     â”‚  â”‚ property_type              â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ fiscal_year    â”‚  â”‚ valid_from     â”‚  â”‚ base_price                 â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ is_weekend     â”‚  â”‚ valid_to       â”‚  â”‚ valid_from                 â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ is_holiday     â”‚  â”‚ is_current     â”‚  â”‚ valid_to                   â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ season         â”‚  â”‚                â”‚  â”‚ is_current                 â”‚  â”‚â”‚â•‘
â•‘  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â•‘
â•‘  â”‚                                         â”‚                                      â”‚â•‘
â•‘  â”‚                                         â–¼                                      â”‚â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â•‘
â•‘  â”‚   â”‚                              FACTS                                        â”‚â”‚â•‘
â•‘  â”‚   â”‚                                                                           â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚              fct_daily_listing_performance                          â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                           â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚                                                                     â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  STRATEGY: INCREMENTAL (merge)      GRAIN: listing Ã— date          â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  UNIQUE KEY: [listing_id, calendar_date]                            â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  ON_SCHEMA_CHANGE: sync_all_columns                                 â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚                                                                     â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”‚ KEYS            â”‚ METRICS           â”‚ DIMENSIONS            â”‚   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”‚ listing_id (FK) â”‚ daily_revenue     â”‚ neighborhood          â”‚   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”‚ calendar_date   â”‚ daily_price       â”‚ property_type         â”‚   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”‚ date_key (FK)   â”‚ is_occupied (0/1) â”‚ room_type             â”‚   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”‚ host_id (FK)    â”‚ is_available      â”‚ 50+ amenity booleans  â”‚   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â”‚                 â”‚ review_score      â”‚ day_of_week_name      â”‚   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â•‘
â•‘  â”‚   â”‚                                      â”‚                                   â”‚â”‚â•‘
â•‘  â”‚   â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚â”‚â•‘
â•‘  â”‚   â”‚                       â”‚                             â”‚                   â”‚â”‚â•‘
â•‘  â”‚   â”‚                       â–¼                             â–¼                   â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ fct_monthly_listing_        â”‚   â”‚ fct_monthly_neighborhood_       â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ performance                 â”‚   â”‚ summary                         â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚                             â”‚   â”‚                                 â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ Grain: listing Ã— month      â”‚   â”‚ Grain: neighborhood Ã— month     â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚                             â”‚   â”‚                                 â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ â€¢ total_monthly_revenue     â”‚   â”‚ â€¢ total_neighborhood_revenue    â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ â€¢ avg_daily_rate            â”‚   â”‚ â€¢ avg_occupancy_rate            â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ â€¢ occupancy_rate            â”‚   â”‚ â€¢ listing_count                 â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â”‚ â€¢ days_occupied             â”‚   â”‚ â€¢ avg_review_score              â”‚ â”‚â”‚â•‘
â•‘  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•‘                                                 â”‚                                   â•‘
â•‘                                                 â–¼                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘  â”‚                       ANALYTICS SCHEMA (analytics.*)                            â”‚â•‘
â•‘  â”‚                       Materialization: VIEW                                     â”‚â•‘
â•‘  â”‚                       Access: ANALYST role (read-only)                          â”‚â•‘
â•‘  â”‚                                                                                 â”‚â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â•‘
â•‘  â”‚   â”‚ problem_1_amenity_revenue     â”‚ AC vs Non-AC monthly revenue split      â”‚  â”‚â•‘
â•‘  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚â•‘
â•‘  â”‚   â”‚ problem_2_neighborhood_pricingâ”‚ YoY price change by neighborhood        â”‚  â”‚â•‘
â•‘  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚â•‘
â•‘  â”‚   â”‚ problem_3a_max_stay_duration  â”‚ Maximum consecutive available days      â”‚  â”‚â•‘
â•‘  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚â•‘
â•‘  â”‚   â”‚ problem_3b_max_stay_lockbox_  â”‚ Max stay with lockbox + first aid kit   â”‚  â”‚â•‘
â•‘  â”‚   â”‚ firstaid                      â”‚                                         â”‚  â”‚â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š Data Model

### Entity Relationship Diagram

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              DIMENSIONAL MODEL                                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                      â•‘
â•‘                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â•‘
â•‘                              â”‚      dim_date       â”‚                                â•‘
â•‘                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                â•‘
â•‘                              â”‚ PK  date_key        â”‚                                â•‘
â•‘                              â”‚     date_day        â”‚                                â•‘
â•‘                              â”‚     day_of_week     â”‚                                â•‘
â•‘                              â”‚     day_of_week_nameâ”‚                                â•‘
â•‘                              â”‚     calendar_month  â”‚                                â•‘
â•‘                              â”‚     calendar_month_ â”‚                                â•‘
â•‘                              â”‚       name          â”‚                                â•‘
â•‘                              â”‚     calendar_quarterâ”‚                                â•‘
â•‘                              â”‚     calendar_year   â”‚                                â•‘
â•‘                              â”‚     fiscal_year     â”‚                                â•‘
â•‘                              â”‚     is_weekend      â”‚                                â•‘
â•‘                              â”‚     is_holiday      â”‚                                â•‘
â•‘                              â”‚     season          â”‚                                â•‘
â•‘                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â•‘
â•‘                                         â”‚                                           â•‘
â•‘                                         â”‚ 1:N                                       â•‘
â•‘                                         â”‚                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â–¼                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚     dim_hosts       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    dim_listings     â”‚  â•‘
â•‘  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    â”‚                         â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â•‘
â•‘  â”‚ PK  host_pk         â”‚    â”‚  fct_daily_listing_     â”‚   â”‚ PK  listing_pk      â”‚  â•‘
â•‘  â”‚ NK  host_id         â”‚â”€â”€â”€â–¶â”‚  performance            â”‚â—€â”€â”€â”‚ NK  listing_id      â”‚  â•‘
â•‘  â”‚     host_name       â”‚ 1:Nâ”‚                         â”‚1:Nâ”‚     listing_name    â”‚  â•‘
â•‘  â”‚     host_location   â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚     neighborhood    â”‚  â•‘
â•‘  â”‚     host_since_date â”‚    â”‚ FK  listing_id          â”‚   â”‚     property_type   â”‚  â•‘
â•‘  â”‚     host_verific... â”‚    â”‚ FK  date_key            â”‚   â”‚     room_type       â”‚  â•‘
â•‘  â”‚     valid_from      â”‚    â”‚ FK  host_id             â”‚   â”‚     accommodates    â”‚  â•‘
â•‘  â”‚     valid_to        â”‚    â”‚     calendar_date       â”‚   â”‚     bedrooms        â”‚  â•‘
â•‘  â”‚     is_current      â”‚    â”‚     daily_price         â”‚   â”‚     beds            â”‚  â•‘
â•‘  â”‚                     â”‚    â”‚     daily_revenue       â”‚   â”‚     bathrooms       â”‚  â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚     is_available        â”‚   â”‚     base_price      â”‚  â•‘
â•‘  â”‚  â”‚  SCD Type 2  â”‚   â”‚    â”‚     is_occupied         â”‚   â”‚     review_scores_  â”‚  â•‘
â•‘  â”‚  â”‚              â”‚   â”‚    â”‚     is_reserved         â”‚   â”‚       rating        â”‚  â•‘
â•‘  â”‚  â”‚ Track host   â”‚   â”‚    â”‚     reservation_id      â”‚   â”‚     "Air cond..." âœ“ â”‚  â•‘
â•‘  â”‚  â”‚ changes over â”‚   â”‚    â”‚     minimum_nights      â”‚   â”‚     "WiFi" âœ“        â”‚  â•‘
â•‘  â”‚  â”‚ time         â”‚   â”‚    â”‚     maximum_nights      â”‚   â”‚     "Pool" âœ“        â”‚  â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚     neighborhood        â”‚   â”‚     ... (50+)       â”‚  â•‘
â•‘  â”‚                     â”‚    â”‚     property_type       â”‚   â”‚     valid_from      â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     room_type           â”‚   â”‚     valid_to        â”‚  â•‘
â•‘                             â”‚     "Air conditioning" âœ“â”‚   â”‚     is_current      â”‚  â•‘
â•‘                             â”‚     "WiFi" âœ“            â”‚   â”‚                     â”‚  â•‘
â•‘                             â”‚     "Pool" âœ“            â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â•‘
â•‘                             â”‚     ... (50+ amenities) â”‚   â”‚  â”‚  SCD Type 2  â”‚   â”‚  â•‘
â•‘                             â”‚     daily_review_score  â”‚   â”‚  â”‚              â”‚   â”‚  â•‘
â•‘                             â”‚                         â”‚   â”‚  â”‚ Track listingâ”‚   â”‚  â•‘
â•‘                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ attribute    â”‚   â”‚  â•‘
â•‘                                         â”‚                 â”‚  â”‚ changes      â”‚   â”‚  â•‘
â•‘                                         â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â•‘
â•‘                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                        â”‚                             â”‚                              â•‘
â•‘                        â–¼                             â–¼                              â•‘
â•‘         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â•‘
â•‘         â”‚ fct_monthly_listing_     â”‚  â”‚ fct_monthly_neighborhood_    â”‚             â•‘
â•‘         â”‚ performance              â”‚  â”‚ summary                      â”‚             â•‘
â•‘         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â•‘
â•‘         â”‚ PK listing_id            â”‚  â”‚ PK neighborhood              â”‚             â•‘
â•‘         â”‚ PK calendar_month        â”‚  â”‚ PK calendar_month            â”‚             â•‘
â•‘         â”‚    calendar_year         â”‚  â”‚    calendar_year             â”‚             â•‘
â•‘         â”‚    total_monthly_revenue â”‚  â”‚    total_monthly_revenue     â”‚             â•‘
â•‘         â”‚    days_available        â”‚  â”‚    listing_count             â”‚             â•‘
â•‘         â”‚    days_occupied         â”‚  â”‚    total_days_occupied       â”‚             â•‘
â•‘         â”‚    occupancy_rate        â”‚  â”‚    avg_occupancy_rate        â”‚             â•‘
â•‘         â”‚    avg_daily_price       â”‚  â”‚    avg_daily_price           â”‚             â•‘
â•‘         â”‚    avg_review_score      â”‚  â”‚    avg_review_score          â”‚             â•‘
â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â•‘
â•‘                                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Key Design Patterns

| Pattern | Implementation | Benefit |
|---------|----------------|---------|
| **SCD Type 2** | dim_hosts, dim_listings, int_amenities_scd | Historical accuracy |
| **Incremental** | fct_daily_listing_performance (7-day window) | Fast refreshes |
| **Pre-Aggregation** | fct_monthly_* | Query performance |
| **Dynamic PIVOT** | Amenity columns via macro | Zero maintenance |
| **Surrogate Keys** | listing_pk, host_pk | Stable joins |
| **Schema Change Detection** | detect_schema_changes.sql | Auto full-refresh |
| **Late Arrival Detection** | check_late_arrivals.sql | Auto backfill |
| **Join Optimization** | INNER where mandatory, >= â‰¤ for ranges | Query performance |
| **Audit Timestamps** | dbt_updated_at on tables only | Data lineage |

---

## ğŸ”„ Schema Change Handling (New Amenities)

### The Challenge

When a new amenity (e.g., "EV Charger") is added to the source data, the incremental fact table must handle:
1. **Schema drift** - New column doesn't exist in target table
2. **Historical backfill** - Old rows need correct value (FALSE, not NULL)
3. **SCD accuracy** - Point-in-time tracking of when amenity was added

### Solution Architecture

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         SCHEMA CHANGE DETECTION FLOW                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                        â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚ STEP 1: DETECTION (Airflow Task: check_schema_changes)                           â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â•‘
â•‘  â”‚  â”‚ get_amenity_columns()   â”‚      â”‚ get_new_amenity_columns()               â”‚   â”‚ â•‘
â•‘  â”‚  â”‚                         â”‚      â”‚                                         â”‚   â”‚ â•‘
â•‘  â”‚  â”‚ Queries source:         â”‚â”€â”€â”€â”€â”€â–¶â”‚ Compares with target table:             â”‚   â”‚ â•‘
â•‘  â”‚  â”‚ SELECT DISTINCT amenity â”‚      â”‚                                         â”‚   â”‚ â•‘
â•‘  â”‚  â”‚ FROM raw.amenities      â”‚      â”‚ Source: [WiFi, Pool, AC, EV Charger]    â”‚   â”‚ â•‘
â•‘  â”‚  â”‚                         â”‚      â”‚ Target: [WiFi, Pool, AC]                â”‚   â”‚ â•‘
â•‘  â”‚  â”‚ Returns:                â”‚      â”‚                                         â”‚   â”‚ â•‘
â•‘  â”‚  â”‚ [WiFi, Pool, AC,        â”‚      â”‚ NEW COLUMNS: ["EV Charger"] âš ï¸          â”‚   â”‚ â•‘
â•‘  â”‚  â”‚  EV Charger]            â”‚      â”‚                                         â”‚   â”‚ â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                            â”‚                                          â•‘
â•‘                                            â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚ STEP 2: BRANCHING DECISION                                                       â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚                         New amenity column detected?                            â”‚ â•‘
â•‘  â”‚                                    â”‚                                            â”‚ â•‘
â•‘  â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚ â•‘
â•‘  â”‚                     â–¼                             â–¼                            â”‚ â•‘
â•‘  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚ â•‘
â•‘  â”‚              â”‚    YES     â”‚                â”‚     NO     â”‚                      â”‚ â•‘
â•‘  â”‚              â”‚            â”‚                â”‚            â”‚                      â”‚ â•‘
â•‘  â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚ â•‘
â•‘  â”‚                    â”‚                             â”‚                             â”‚ â•‘
â•‘  â”‚                    â–¼                             â–¼                             â”‚ â•‘
â•‘  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â•‘
â•‘  â”‚         â”‚    FULL REFRESH      â”‚      â”‚     INCREMENTAL      â”‚                â”‚ â•‘
â•‘  â”‚         â”‚                      â”‚      â”‚                      â”‚                â”‚ â•‘
â•‘  â”‚         â”‚ dbt run              â”‚      â”‚ dbt run              â”‚                â”‚ â•‘
â•‘  â”‚         â”‚ --full-refresh       â”‚      â”‚ (default, last 7d)   â”‚                â”‚ â•‘
â•‘  â”‚         â”‚ -s fct_daily_*       â”‚      â”‚ -s fct_daily_*       â”‚                â”‚ â•‘
â•‘  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                            â”‚                                          â•‘
â•‘                                            â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚ STEP 3: SCD TYPE 2 TRACKING                                                      â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  int_listing_amenities_scd tracks WHEN each amenity was added per listing:      â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â•‘
â•‘  â”‚  â”‚ listing_id â”‚ valid_from â”‚ valid_to   â”‚ "WiFi" â”‚ "Pool" â”‚ "EV Charger"     â”‚ â”‚ â•‘
â•‘  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â•‘
â•‘  â”‚  â”‚ 101        â”‚ 2024-01-01 â”‚ 2024-05-31 â”‚ TRUE   â”‚ FALSE  â”‚ FALSE (default)  â”‚ â”‚ â•‘
â•‘  â”‚  â”‚ 101        â”‚ 2024-06-01 â”‚ 9999-12-31 â”‚ TRUE   â”‚ TRUE   â”‚ TRUE  (added!)   â”‚ â”‚ â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  âœ… Point-in-time accuracy:                                                     â”‚ â•‘
â•‘  â”‚     â€¢ Before 2024-06-01: "EV Charger" = FALSE (amenity didn't exist yet)       â”‚ â•‘
â•‘  â”‚     â€¢ After 2024-06-01:  "EV Charger" = TRUE  (amenity was added)              â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                            â”‚                                          â•‘
â•‘                                            â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚ STEP 4: FACT TABLE RESULT (After Full Refresh)                                   â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  fct_daily_listing_performance with correct historical values:                  â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â•‘
â•‘  â”‚  â”‚ listing_id â”‚ date       â”‚ "WiFi" â”‚ "Pool" â”‚ "EV Charger"                 â”‚  â”‚ â•‘
â•‘  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â•‘
â•‘  â”‚  â”‚ 101        â”‚ 2024-01-15 â”‚ TRUE   â”‚ FALSE  â”‚ FALSE âœ… Correctly backfilledâ”‚  â”‚ â•‘
â•‘  â”‚  â”‚ 101        â”‚ 2024-03-20 â”‚ TRUE   â”‚ FALSE  â”‚ FALSE âœ… Correctly backfilledâ”‚  â”‚ â•‘
â•‘  â”‚  â”‚ 101        â”‚ 2024-06-15 â”‚ TRUE   â”‚ TRUE   â”‚ TRUE  âœ… New value applied   â”‚  â”‚ â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â•‘
â•‘  â”‚                                                                                  â”‚ â•‘
â•‘  â”‚  âœ… Historical rows correctly show FALSE for amenities before they existed     â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Components Involved

| Component | File | Purpose |
|-----------|------|---------|
| **Dynamic Column Macro** | `macros/get_amenity_columns.sql` | Query source for all amenity names |
| **Schema Detection Macro** | `macros/detect_schema_changes.sql` | Compare source vs target columns |
| **Fact Table Config** | `fct_daily_listing_performance.sql` | `on_schema_change='sync_all_columns'` |
| **Airflow Task** | `dags/dbt_rental_property_dag.py` | `check_schema_changes` branching |
| **SCD Model** | `int_listing_amenities_scd.sql` | Track amenity history per listing |

### Manual Commands

```bash
# Check for new amenities without running pipeline
dbt run-operation check_amenity_schema_change

# Output if new amenities found:
# ğŸš¨ SCHEMA CHANGE DETECTED!
# New amenities found in source: EV Charger, Heated Pool
# ACTION REQUIRED: Run full refresh

# Force full refresh
dbt run --full-refresh -s fct_daily_listing_performance+

# Normal incremental (Airflow handles decision automatically)
dbt run -s fct_daily_listing_performance
```

### Why Full Refresh on Schema Change?

| Approach | Historical Rows | Accuracy |
|----------|-----------------|----------|
| Incremental only | NULL for new column | âŒ Incorrect |
| Full Refresh | FALSE (via SCD join) | âœ… Accurate |

**Key Insight**: The SCD Type 2 join ensures that historical rows get `FALSE` for amenities that didn't exist at that point in time, maintaining analytical accuracy.

### Additional Components (Late Arrivals)
- `macros/check_late_arrivals.sql`: Detects late-arriving rows (old business dates, recently ingested via `_loaded_at`). Returns a count and logs `LATE_ARRIVAL_COUNT`.
- `dags/dbt_rental_property_dag.py`: Branches on `check_late_arrivals`; if late arrivals exist, it forces a full refresh of `fct_daily_listing_performance` (and downstream marts) instead of the incremental run.

---

## ğŸ• Audit Timestamps & Data Lineage

### Overview
All **TABLE** models include a `dbt_updated_at` column (current_timestamp) to track when rows were inserted or last updated by dbt. **VIEW** models do not have this column as they compute results on-the-fly.

### Implementation

| Layer | Models | Audit Timestamp |
|-------|--------|-----------------|
| **Staging** | 4 views | âŒ No (views don't persist) |
| **Intermediate** | 5 views | âŒ No (views don't persist) |
| **Marts** | 6 tables | âœ… Yes (`dbt_updated_at`) |
| **Analytics** | 4 views | âŒ No (views don't persist) |

### Tables with `dbt_updated_at`

```
RENTAL_PROPERTY.MART:
â”œâ”€â”€ dim_date                          â†’ Last refreshed timestamp
â”œâ”€â”€ dim_hosts                         â†’ Last refreshed timestamp  
â”œâ”€â”€ dim_listings                      â†’ Last refreshed timestamp
â”œâ”€â”€ fct_daily_listing_performance     â†’ Insert/update timestamp per row
â”œâ”€â”€ fct_monthly_listing_performance   â†’ Last refreshed timestamp
â””â”€â”€ fct_monthly_neighborhood_summary  â†’ Last refreshed timestamp
```

### Use Cases

| Use Case | Query Example |
|----------|---------------|
| **Find stale rows** | `SELECT * FROM fct_daily WHERE dbt_updated_at < current_date - 30` |
| **Audit data lineage** | `SELECT MAX(dbt_updated_at) FROM dim_listings` |
| **Identify updated rows** | `SELECT * FROM fct_daily WHERE dbt_updated_at > '2024-01-13 06:00:00'` |
| **Incremental verification** | Check if recent 7 days have today's timestamp |

### Behavior in Incremental Models

For `fct_daily_listing_performance`:
- **First run**: All rows get `dbt_updated_at` = run timestamp
- **Incremental (7-day)**: Only rows in the last 7 days get updated timestamp
- **Full refresh**: All rows get new timestamp
- **Rows outside window**: Keep original `dbt_updated_at` from creation

This enables you to identify:
- Which rows were touched by the most recent run
- Which historical rows haven't been refreshed in a long time
- When specific data was last validated/updated

---

## âš¡ Join Strategy & Performance Optimizations

### Join Type Decision Matrix

All joins have been optimized based on business logic and performance requirements:

| Model | Join | Type | Rationale |
|-------|------|------|-----------|
| `stg_listings` | base â†’ amenities | **LEFT** | Preserve listings even if JSON parsing fails |
| `int_availability_spans` | spans â†’ listings | **INNER** | Calendar entries must have valid listings |
| `int_calendar_enriched` | calendar â†’ listings | **INNER** | Orphan calendar rows are data quality issues |
| `int_calendar_enriched` | calendar â†’ amenities_scd | **LEFT** | Not all dates have SCD records |
| `int_listings_history` | listings â†’ amenity_dates | **LEFT** | Listings may exist before first changelog |
| `fct_daily_listing_performance` | calendar â†’ listings | **INNER** | Required relationship |
| `fct_daily_listing_performance` | enriched â†’ amenities_scd | **LEFT** | Optional SCD enrichment |
| `fct_daily_listing_performance` | enriched â†’ reviews | **LEFT** | Not all days have reviews |
| `dim_listings` | history â†’ amenities_scd | **LEFT** | Listings may predate amenity tracking |
| `problem_1` | fact â†’ dim_date | **INNER** | Dimension should cover all fact dates |
| `problem_2` | all_listings â†’ prices | **LEFT Ã— 2** | Show data completeness explicitly |
| `problem_3a/b` | listings â†’ dimensions | **LEFT** | Dimension data may be incomplete |

### Date Range Join Optimization

For SCD joins with `BETWEEN`, we use explicit `>=` and `<=` for better Snowflake optimizer performance:

```sql
-- âŒ Slower (confuses optimizer)
and calendar_date BETWEEN valid_from AND valid_to

-- âœ… Faster (explicit range predicates)
and calendar_date >= valid_from 
and calendar_date <= valid_to
```

**Applied in:**
- `int_calendar_enriched.sql` (calendar â†’ amenities_scd)
- `fct_daily_listing_performance.sql` (calendar â†’ amenities_scd)

### Performance Recommendations

| Optimization | When to Apply | Expected Impact |
|--------------|---------------|-----------------|
| **Clustering** | `fct_daily_listing_performance` on `(listing_id, calendar_date)` | 50-70% scan reduction |
| **Search Optimization** | High-cardinality text columns (neighborhood, listing_name) | Faster WHERE clauses |
| **Increase threads** | Change `profiles.yml` threads: 1 â†’ 4 | Parallel model execution |
| **Larger warehouse** | Full refresh or high volume | Faster query execution |
| **Materialized CTEs** | Complex intermediate views with reuse | Reduce redundant computation |

---

## ğŸ’¡ Business Questions Answered

### Problem 1: Amenity Revenue Analysis
> *"What percentage of monthly revenue comes from listings with/without air conditioning?"*

```sql
SELECT * FROM analytics.problem_1_amenity_revenue;
```

| Month | AC Segment | Revenue | % of Monthly |
|-------|------------|---------|--------------|
| 2022-07 | With AC | $45,230 | 78.8% |
| 2022-07 | Without AC | $12,150 | 21.2% |

---

### Problem 2: Neighborhood Pricing
> *"What is the average price change by neighborhood from July 2021 to July 2022?"*

```sql
SELECT * FROM analytics.problem_2_neighborhood_pricing;
```

| Neighborhood | Listings | Avg Price 2021 | Avg Price 2022 | Change |
|--------------|----------|----------------|----------------|--------|
| Back Bay | 1 | $106.00 | $150.00 | +$44.00 |
| Charlestown | 5 | $203.80 | $225.60 | +$21.80 |

---

### Problem 3A & 3B: Maximum Stay Duration
> *"What is the longest consecutive period a guest could stay?"*

```sql
-- All listings
SELECT * FROM analytics.problem_3a_max_stay_duration;

-- With lockbox AND first aid kit
SELECT * FROM analytics.problem_3b_max_stay_lockbox_firstaid;
```

**Key Insight:** Max stay drops from **365 nights** to **180 nights** when filtered

---

## â„ï¸ Snowflake Setup

### 1. Create Database & Schemas

```sql
CREATE OR REPLACE DATABASE rental_property;

CREATE OR REPLACE SCHEMA rental_property.raw;
CREATE OR REPLACE SCHEMA rental_property.stagging;
CREATE OR REPLACE SCHEMA rental_property.development;
CREATE OR REPLACE SCHEMA rental_property.mart;
CREATE OR REPLACE SCHEMA rental_property.analytics;
```

### 2. Create Roles & Users

```sql
USE ROLE SECURITYADMIN;

-- TRANSFORM role (for dbt)
CREATE OR REPLACE ROLE TRANSFORM;
GRANT ROLE TRANSFORM TO ROLE ACCOUNTADMIN;

-- dbt service user
CREATE USER IF NOT EXISTS dbt
  LOGIN_NAME = 'dbt'
  TYPE = SERVICE
  RSA_PUBLIC_KEY = '<YOUR_PUBLIC_KEY>'
  DEFAULT_ROLE = TRANSFORM
  DEFAULT_WAREHOUSE = 'COMPUTE_WH';

GRANT ROLE TRANSFORM TO USER dbt;
```

### 3. Grant Permissions

```sql
USE ROLE ACCOUNTADMIN;

GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE TRANSFORM;
GRANT ALL ON DATABASE rental_property TO ROLE TRANSFORM;
GRANT ALL ON ALL SCHEMAS IN DATABASE rental_property TO ROLE TRANSFORM;
GRANT ALL ON FUTURE SCHEMAS IN DATABASE rental_property TO ROLE TRANSFORM;
GRANT SELECT, INSERT, UPDATE, DELETE ON FUTURE TABLES IN DATABASE rental_property TO ROLE TRANSFORM;
```

### 4. Create Analyst Role (Read-Only)

```sql
USE ROLE SECURITYADMIN;
CREATE OR REPLACE ROLE ANALYST;

USE ROLE ACCOUNTADMIN;
GRANT USAGE ON WAREHOUSE COMPUTE_WH TO ROLE ANALYST;
GRANT USAGE ON DATABASE RENTAL_PROPERTY TO ROLE ANALYST;
GRANT USAGE ON SCHEMA RENTAL_PROPERTY.ANALYTICS TO ROLE ANALYST;
GRANT SELECT ON ALL VIEWS IN SCHEMA RENTAL_PROPERTY.ANALYTICS TO ROLE ANALYST;
GRANT SELECT ON FUTURE VIEWS IN SCHEMA RENTAL_PROPERTY.ANALYTICS TO ROLE ANALYST;
```

| Role | Access | Use Case |
|------|--------|----------|
| `TRANSFORM` | Full access | dbt transformations |
| `ANALYST` | SELECT on analytics only | Business users |

---

## ğŸ–¥ Running the Project

### Local Development

```bash
pip install dbt-snowflake
dbt run
dbt test
dbt docs generate && dbt docs serve
```

### Docker Deployment

```bash
cp env.example .env
# Edit .env with credentials
docker-compose up -d
open http://localhost:8080  # admin / admin
```

---

## ğŸ”” Monitoring & Alerts

### Source Freshness Thresholds

| Source | Warn | Error |
|--------|------|-------|
| `raw.calendar` | 24h | 48h |
| `raw.listings` | 7d | 14d |
| `raw.reviews` | 7d | 14d |
| `raw.amenities` | 7d | 14d |

### Alert Actions

| Status | Pipeline | Notification |
|--------|----------|--------------|
| âœ… Fresh | Continues | None |
| âš ï¸ Warning | Continues | Log warning |
| ğŸš¨ Stale | **Blocked** | Email sent |

---

## ğŸ§ª Tests & Data Quality

| Level | Scope | Key tests (examples) |
|-------|-------|----------------------|
| Sources (`raw.*`) | Freshness + key columns | Freshness on `_loaded_at`; `unique`/`not_null` on `listings.id`; `not_null` on `calendar.date`/`listing_id`; `unique`+`not_null` (warn) on `generated_reviews.id`; `not_null` on `amenities_changelog` `listing_id`/`change_at`/`amenities`. |
| Staging | Cleaned views | `unique`/`not_null` on `stg_listings.listing_id`; `not_null` on `stg_calendar.listing_id`/`calendar_date`; `unique` + `not_null` (warn) on `stg_reviews.review_id`; `not_null` on `stg_amenities_changelog.listing_id`/`change_at`. |
| Intermediate | SCD prep + spans | `not_null` on `int_listing_amenities_scd` `listing_id`/`valid_from`/`valid_to`; `int_calendar_enriched` `listing_id`/`calendar_date`; `int_availability_spans` `listing_id`/`span_start_date`/`span_end_date`; `int_hosts_history.host_id` `unique`/`not_null`; `valid_from`/`valid_to` not_null; same for `int_listings_history`. |
| Marts (Dims) | `dim_date`, `dim_hosts`, `dim_listings` | `unique`/`not_null` on keys; accepted values on `season`, `host_experience_tier`, capacity/price/rating tiers (rating tier warn severity); `is_current` not_null on SCD dims. |
| Marts (Facts) | `fct_daily_listing_performance`, `fct_monthly_listing_performance`, `fct_monthly_neighborhood_summary` | `not_null` on grain keys (`listing_id`, `calendar_date`/`calendar_month`, `date_key`, `neighborhood`); accepted values [0,1] for `is_occupied`, `available_flag`, `is_blocked`. |
| Ops controls | Freshness & backfill gating | `dbt source freshness`; `check_late_arrivals` macro; schema-change detection macro + `on_schema_change='sync_all_columns'` on incremental fact. |
| Singular tests | Custom SQL | `tests/` directory is currently empty (no extra singular tests beyond the YAML-defined ones). |

---

## âš ï¸ Edge Cases & Future Enhancements

### Data Quality Edge Cases

| # | Edge Case | Current Behavior | Recommended Solution |
|---|-----------|------------------|---------------------|
| **1** | **Malformed JSON in amenities** | PARSE_JSON fails â†’ entire `stg_listings` model errors â†’ pipeline stops | **Solution**: Wrap with TRY_PARSE_JSON and add data quality test to flag unparseable rows. Log errors for upstream data team to fix. Alternative: Use Snowflake variant type with lenient parsing. |
| **2** | **Duplicate listing_ids in raw.listings** | Staging returns duplicates â†’ downstream joins multiply rows â†’ inflated aggregations | **Solution**: Add `unique` test with severity `error` on `source('raw', 'listings').id`. Pipeline will block until duplicates are resolved at source. |
| **3** | **Review dates outside calendar range** | LEFT JOIN orphans reviews â†’ lost in fact table. If backdated reviews exist, they're not counted | **Solution**: Add date range validation test: `expect_column_values_to_be_between` on review_date to match calendar min/max. Or extend calendar table to cover wider date range. |

---

### Schema/Column Edge Cases

| # | Edge Case | Current Behavior | Recommended Solution |
|---|-----------|------------------|---------------------|
| **4** | **Amenity name collisions** (e.g., "WiFi" vs "Wi-Fi") | Become separate columns â†’ fragmented analytics. Queries referencing "WiFi" miss "Wi-Fi" listings | **Solution**: Create amenity alias seed table or normalization model with CASE-based mapping: `CASE WHEN amenity IN ('WiFi','Wi-Fi','wifi') THEN 'WiFi' END`. Update analytics to use normalized names. |
| **5** | **_loaded_at column missing** | `dbt source freshness` fails â†’ pipeline blocks. Late-arrival detection returns 0 with warning | **Solution**: Add `_loaded_at` during ingestion (ETL layer). If impossible, modify freshness checks to use alternative timestamp (e.g., `MAX(calendar_date)` for calendar table) or disable freshness entirely. |
| **6** | **New non-amenity columns in raw** | Ignored silently â†’ not available for analysis. Only amenities are handled dynamically | **Solution**: Implement column-diff macro that compares `information_schema.columns` between raw and staging. Alert data team when new columns appear. Manual staging SQL update still required. |

---

### Performance Edge Cases

| # | Edge Case | Current Behavior | Recommended Solution |
|---|-----------|------------------|---------------------|
| **7** | **Sudden 100x volume spike** | Incremental MERGE on 7-day window processes 100x rows â†’ task timeout or warehouse saturation | **Solution**: (1) Auto-scale warehouse based on row count threshold. (2) Add dynamic window sizing: if last 7 days > 10M rows, widen window but split into daily chunks. (3) Increase `execution_timeout` in DAG default_args. (4) Add clustering on `(listing_id, calendar_date)`. |
| **8** | **SCD explosion** (daily amenity micro-updates) | Thousands of SCD records per listing â†’ date-range joins scan entire table â†’ slow queries | **Solution**: (1) Add clustering key on `(listing_id, valid_from, valid_to)`. (2) Materialize `int_calendar_enriched` as incremental table instead of view to pre-join amenities. (3) Aggregate changelog to weekly/monthly snapshots if daily changes aren't needed. |
| **9** | **50+ new amenities at once** | Dynamic PIVOT generates 100+ columns â†’ slower compilation, larger table scans, approaching Snowflake's ~1000 column limit | **Solution**: (1) Monitor column count with test: `expect_table_column_count_to_be_less_than: 500`. (2) Alternative schema: store amenities as VARIANT/JSON or separate amenity bridge table instead of wide columns. (3) Implement amenity grouping/aggregation. |

---

### SCD/Historical Edge Cases

| # | Edge Case | Current Behavior | Recommended Solution |
|---|-----------|------------------|---------------------|
| **10** | **Listing created before first changelog** | LEFT JOIN gives NULL for amenities â†’ uses listing's current amenities via fallback. Early revenue may be incorrectly attributed | **Solution**: Add synthetic "listing creation" record to amenities_changelog with initial amenity state. Or use `COALESCE(scd_value, FALSE)` explicitly to mark absence. Document assumption in model header. |
| **11** | **Retroactive changelog correction** | Admin backdates `change_at` to fix history â†’ late-arrival check misses it (checks `_loaded_at`, not `change_at`) â†’ fact table not refreshed | **Solution**: Separate detection for changelog updates: macro compares `MAX(change_at)` vs `MAX(calendar_date)` in fact table. If changelog has older dates than last fact refresh, trigger targeted backfill for affected date range. |
| **12** | **is_current flag out of sync** | If SCD LEAD() logic has bugs or manual updates occur, multiple records per listing could have `is_current=TRUE` â†’ dimension joins return duplicates | **Solution**: Add unique compound test on dimensions: `dbt_utils.unique_combination_of_columns` on `['natural_key', 'is_current']` WHERE `is_current=TRUE`. Add post-hook to validate only one current record per entity. |

---

### Future Enhancement Opportunities

| Priority | Enhancement | Benefit | Effort |
|----------|-------------|---------|--------|
| ğŸ”´ **High** | Add TRY_PARSE_JSON wrapper for amenities | Graceful degradation for bad data | Low |
| ğŸ”´ **High** | Implement amenity name normalization | Consolidate "WiFi" vs "Wi-Fi" analysis | Medium |
| ğŸ”´ **High** | Add _loaded_at to all raw tables | Enable proper late-arrival detection | Low |
| ğŸŸ¡ **Medium** | Materialize int_calendar_enriched as incremental | Improve SCD join performance | Medium |
| ğŸŸ¡ **Medium** | Add clustering keys to large tables | 50-70% query performance improvement | Low |
| ğŸŸ¡ **Medium** | Implement chunked backfill strategy | Handle large historical updates safely | High |
| ğŸŸ¢ **Low** | Convert amenities to bridge table | Support 1000+ amenities without column explosion | High |
| ğŸŸ¢ **Low** | Add Snowflake task-based triggers | Event-driven pipeline instead of daily cron | Medium |
| ğŸŸ¢ **Low** | Implement dbt metrics/semantic layer | Standardized business metric definitions | Medium |

---

### Production Readiness Checklist

- [x] Source freshness monitoring with `_loaded_at`
- [x] Late-arrival detection with automatic backfill
- [x] Schema change detection with automatic full refresh
- [x] Audit timestamps on all tables (`dbt_updated_at`)
- [x] Comprehensive data quality tests (63 tests)
- [x] SCD Type 2 for historical accuracy
- [x] Incremental loading for performance
- [x] Dynamic amenity handling (no hardcoding)
- [x] Join optimization (INNER where required)
- [x] Airflow orchestration with error handling
- [ ] TRY_PARSE_JSON for malformed data handling
- [ ] Amenity name normalization/aliasing
- [ ] Clustering keys on large fact tables
- [ ] Auto-scaling warehouse configuration
- [ ] Retroactive changelog detection
- [ ] SCD uniqueness validation

---

<p align="center">
  Built with â¤ï¸ using <b>dbt</b> + <b>Snowflake</b> + <b>Airflow</b>
</p>
